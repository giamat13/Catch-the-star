<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>×ª×¤×•×¡ ××ª ×”×›×•×›×‘×™× - 20 ×©×œ×‘×™×</title>
    <style>
        body {
            margin: 0;
            padding: 10px;
            background: linear-gradient(135deg, #1e3c72, #2a5298, #1a237e);
            font-family: Arial, sans-serif;
            color: white;
            overflow: hidden;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }
        
        #gameContainer {
            position: relative;
            width: 100%;
            height: calc(100vh - 200px);
            min-height: 400px;
            max-height: 800px;
            border: 3px solid #fff;
            border-radius: 15px;
            background: radial-gradient(circle at center, #0f1419, #1a237e);
            overflow: hidden;
            cursor: crosshair;
            flex-grow: 1;
            max-width: 900px;
            margin: auto;
        }
        
        #gameInfo {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
            padding: 10px 0;
            max-width: 900px;
        }
        
        .info-panel {
            background-color: rgba(0, 0, 0, 0.4);
            padding: 8px 15px;
            border-radius: 10px;
            text-align: center;
            border: 1px solid rgba(255, 255, 255, 0.2);
            font-size: 1.1em;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .info-panel span {
            font-weight: bold;
            font-size: 1.2em;
        }
        
        #progress {
            width: 100%;
            height: 25px;
            background-color: #333;
            border-radius: 12px;
            border: 1px solid #555;
            position: relative;
            margin-top: 5px;
        }
        
        #progressFill {
            height: 100%;
            background: linear-gradient(90deg, #4caf50, #8bc34a);
            border-radius: 12px;
            transition: width 0.3s ease-in-out;
        }
        
        #progressText {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 0.9em;
            text-shadow: 1px 1px 2px #000;
        }
        
        .falling-object {
            position: absolute;
            font-size: 2.5em;
            user-select: none;
            cursor: pointer;
            transition: transform 0.1s;
        }
        
        .falling-object:hover {
            transform: scale(1.2);
        }
        
        .star {
            color: yellow;
        }
        
        .star-blue {
            color: #4dd0e1;
        }
        
        .star-silver {
            color: #bdbdbd;
        }
        
        .star-gold {
            color: #ffc107;
        }
        
        .star-rainbow {
            text-shadow: 0 0 5px #fff, 0 0 10px #f00, 0 0 15px #0f0, 0 0 20px #00f, 0 0 25px #ff0, 0 0 30px #0ff, 0 0 35px #f0f;
            animation: pulse 1s infinite alternate;
        }
        
        .bomb {
            color: #f44336;
        }
        
        .blackhole {
            color: #212121;
            filter: drop-shadow(0 0 10px #000);
        }
        
        .lightning {
            color: #ffeb3b;
        }

        .powerup {
            font-size: 2.2em;
        }
        
        .player {
            position: absolute;
            font-size: 2.5em;
            transition: transform 0.1s;
        }

        .player-shield {
            animation: shield-pulse 1s infinite;
            border: 2px solid cyan;
            border-radius: 50%;
            padding: 5px;
            margin: -5px;
        }

        @keyframes shield-pulse {
            0% { box-shadow: 0 0 0 0 rgba(0, 255, 255, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(0, 255, 255, 0); }
            100% { box-shadow: 0 0 0 0 rgba(0, 255, 255, 0); }
        }

        .points-text, .combo-text {
            position: absolute;
            font-weight: bold;
            animation: fade-up 1s forwards;
            pointer-events: none;
            white-space: nowrap;
        }
        
        .points-text {
            color: #ffeb3b;
        }
        
        .combo-text {
            color: #4caf50;
            font-size: 1.2em;
        }
        
        @keyframes fade-up {
            from {
                opacity: 1;
                transform: translateY(0);
            }
            to {
                opacity: 0;
                transform: translateY(-50px);
            }
        }
        
        #modal {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: rgba(0, 0, 0, 0.7);
            padding: 30px;
            border-radius: 15px;
            text-align: center;
            z-index: 100;
            width: 80%;
            max-width: 400px;
        }
        
        #modal h2 {
            font-size: 2em;
            margin-top: 0;
        }

        #modal p {
            font-size: 1.2em;
            margin: 10px 0;
        }

        #modal button {
            background-color: #4caf50;
            color: white;
            border: none;
            padding: 15px 25px;
            font-size: 1.1em;
            border-radius: 8px;
            cursor: pointer;
            margin: 10px;
            transition: background-color 0.3s;
        }
        
        #modal button:hover {
            background-color: #45a049;
        }
        
        #stageComplete, #gameOver, #levelComplete {
            display: none;
        }

        .legend {
            font-size: 0.9em;
            color: rgba(255, 255, 255, 0.8);
            margin-top: 5px;
        }

        .legend span {
            display: inline-block;
            margin-right: 15px;
        }

        @keyframes pulse {
            from { transform: scale(1); }
            to { transform: scale(1.1); }
        }

        /* Responsive design */
        @media (max-width: 600px) {
            #gameInfo {
                flex-direction: column;
                gap: 10px;
            }
            .info-panel {
                width: 100%;
                justify-content: center;
            }
            .info-panel:first-child, .info-panel:last-child {
                display: none;
            }
            #modal {
                width: 95%;
            }
        }
    </style>
</head>
<body>
    <div id="gameInfo">
        <div class="info-panel" id="scorePanel">
            × ×™×§×•×“: <span id="score">0</span>
        </div>
        <div class="info-panel" id="comboPanel">
            ×§×•××‘×•: <span id="combo">x1</span>
        </div>
        <div class="info-panel" id="livesPanel">
            ×—×™×™×: <span id="lives">3</span> â¤ï¸
        </div>
    </div>
    
    <div id="gameContainer">
        <div id="player" class="player">ğŸ¯</div>
        <div id="modal" style="display: block;">
            <h2 id="stageTitle">×ª×¤×•×¡ ××ª ×”×›×•×›×‘×™×!</h2>
            <p id="stageGoal">×™×¢×“: 100 × ×§×•×“×•×ª</p>
            <p id="globalLevel">×¨××” ×’×œ×•×‘×œ×™×ª: 1 (××›×¤×™×œ × ×§×•×“×•×ª: x1)</p>
            <p id="stageNum">1/20</p>
            <button onclick="startStage(1)">×”×ª×—×œ ××©×—×§</button>
            <div id="progress">
                <div id="progressFill"></div>
                <div id="progressText">0 / 100</div>
            </div>
            <div class="legend">
                <span>ğŸ›¡ï¸: ××’×Ÿ</span>
                <span>â¤ï¸: ×—×™×™×</span>
                <span>âš¡: ××”×™×¨×•×ª</span>
                <span id="freezeLegend">â„ï¸: ×”×§×¤××” (×¨××” 2)</span>
                <span id="magnetLegend">ğŸ§²: ××’× ×˜ (×¨××” 3)</span>
                <span id="doubleLegend">ğŸ’: × ×™×§×•×“ ×›×¤×•×œ (×¨××” 4)</span>
            </div>
        </div>

        <div id="stageComplete" class="modal">
            <h2>×©×œ×‘ ×”×•×©×œ×!</h2>
            <p>×©×œ×‘ <span id="completedStage">1</span>: <span id="completedStageName">×”×ª×—×œ×”</span></p>
            <p>× ×™×§×•×“ ×‘×©×œ×‘: <span id="stageScore">0</span></p>
            <p>×–××Ÿ: <span id="stageTime">0</span> ×©× ×™×•×ª</p>
            <p>×§×•××‘×• ××§×¡×™××œ×™: <span id="stageMaxCombo">x1</span></p>
            <p>×›×•×›×‘×™× ×©× ×ª×¤×¡×•: <span id="starsCaught">0</span></p>
            <div class="legend-stats">
                <p>××•×™×‘×™× ×©×”×•×—××¦×•:</p>
                <span>ğŸ’¥: <span id="bombsAvoided">0</span></span>
                <span>ğŸ•³ï¸: <span id="blackholesAvoided">0</span></span>
                <span>â›ˆï¸: <span id="lightningAvoided">0</span></span>
            </div>
            <button onclick="checkLevelUp()" id="nextStageText">×©×œ×‘ ×”×‘× â†’</button>
        </div>

        <div id="gameOver" class="modal">
            <h2>× ×’××¨×• ×”×—×™×™×!</h2>
            <p>× ×™×§×•×“: <span id="failScore">0</span></p>
            <p>×™×¢×“: <span id="failTarget">0</span></p>
            <button onclick="retryStage()">× ×¡×” ×©×•×‘</button>
            <button onclick="restartGame()">×”×ª×—×œ ××—×“×©</button>
        </div>

        <div id="levelComplete" class="modal">
            <h2>×¨××” ×”×•×©×œ××”!</h2>
            <p>×‘×¨×›×•×ª! ×¡×™×™××ª ××ª ×¨××” <span id="completedLevel">1</span>!</p>
            <p>×¢×œ×™×ª ×œ×¨××” <span id="newLevel">2</span>.</p>
            <p>××›×¤×™×œ ×”× ×§×•×“×•×ª ×©×œ×š ×”×•× ×›×¢×ª: x<span id="newMultiplier">2</span></p>
            <button onclick="nextLevel()">×”×ª×—×œ ×¨××” ×—×“×©×”</button>
        </div>
    </div>

    <div id="gameStats">
        <div class="info-panel" id="stageProgressPanel">
            ×”×ª×§×“××•×ª ×©×œ×‘: <span id="stageNum">1/20</span>
            <div id="progress" style="width: 150px; margin: 0 10px;">
                <div id="progressFill"></div>
                <div id="progressText">0 / 100</div>
            </div>
        </div>
        <div class="info-panel" id="levelProgressPanel">
            ×”×ª×§×“××•×ª ×¨××”: <span id="completedStages">0/20</span>
            <div id="progress" style="width: 150px; margin: 0 10px;">
                <div id="levelProgressFill"></div>
                <div id="levelProgressText">0/20</div>
            </div>
        </div>
        <div class="info-panel" id="specialStatusPanel">
            ×¡×˜×˜×•×¡ ××™×•×—×“: <span id="special">××™×Ÿ</span>
        </div>
    </div>

    <script>
        let globalLevel = 1;
        let currentStage = 1;
        let score = 0;
        let levelScore = 0;
        let lives = 3;
        let gameRunning = false;
        let starSpeed = 2;
        let spawnRate = 0.025;
        let bombChance = 0.1;
        let combo = 1;
        let comboCount = 0;
        let maxCombo = 1;
        let shieldTime = 0;
        let speedBoostTime = 0;
        let freezeTime = 0;
        let magnetTime = 0;
        let doublePointsTime = 0;
        let lastStarType = null;
        let stageStartTime = 0;
        
        // Stage stats
        let starsCaught = 0;
        let bombsAvoided = 0;
        let blackholesAvoided = 0;
        let lightningAvoided = 0;
        
        // Level stats
        let levelStarsCaught = 0;

        let gameInterval;
        let timerInterval;
        
        const baseStageTargets = [
            100, 150, 200, 280, 370, 480, 600, 750, 920, 1120,
            1350, 1620, 1930, 2280, 2670, 3100, 3570, 4080, 4630, 5220
        ];
        
        const stageNames = [
            "×”×ª×—×œ×”", "×¦×¢×“×™× ×¨××©×•× ×™×", "××ª×¨×’×œ", "××‘×™×Ÿ", "××ª××™×“", 
            "××ª×—××", "××ª×§×“×", "×××ª×’×¨", "×§×©×”", "××•×¨×›×‘",
            "××§×¦×•×¢×™", "××•××—×”", "×××Ÿ", "×•×™×¨×˜×•××•×–", "×’××•×Ÿ",
            "××“×”×™×", "××’×“×™", "×‘×œ×ª×™ ×™×ª×•××¨", "×¢×œ ×× ×•×©×™", "××•×©×œ×"
        ];
        
        const baseStarTypes = [
            { emoji: 'â­', basePoints: 5, chance: 0.4, class: 'star-regular' },
            { emoji: 'ğŸŒŸ', basePoints: 10, chance: 0.3, class: 'star-blue' },
            { emoji: 'ğŸ’«', basePoints: 20, chance: 0.15, class: 'star-silver' },
            { emoji: 'ğŸŒ ', basePoints: 50, chance: 0.08, class: 'star-gold' },
            { emoji: 'ğŸ†', basePoints: 100, chance: 0.02, class: 'star-rainbow' }
        ];
        
        const powerupTypes = [
            { emoji: 'ğŸ›¡ï¸', type: 'shield', chance: 0.04, minLevel: 1 },
            { emoji: 'â¤ï¸', type: 'life', chance: 0.03, minLevel: 1 },
            { emoji: 'âš¡', type: 'speed', chance: 0.04, minLevel: 1 },
            { emoji: 'â„ï¸', type: 'freeze', chance: 0.02, minLevel: 2 },
            { emoji: 'ğŸ§²', type: 'magnet', chance: 0.02, minLevel: 3 },
            { emoji: 'ğŸ’', type: 'double', chance: 0.02, minLevel: 4 }
        ];
        
        const gameContainer = document.getElementById('gameContainer');
        const player = document.getElementById('player');
        
        let mouseX = window.innerWidth / 2;
        let mouseY = window.innerHeight / 2;
        
        function updatePlayerPosition(clientX, clientY) {
            if (!gameRunning) return;
            const rect = gameContainer.getBoundingClientRect();
            mouseX = clientX - rect.left;
            mouseY = clientY - rect.top;
            
            mouseX = Math.max(20, Math.min(rect.width - 20, mouseX));
            mouseY = Math.max(20, Math.min(rect.height - 20, mouseY));
            
            player.style.left = (mouseX - 20) + 'px';
            player.style.top = (mouseY - 20) + 'px';
        }
        
        gameContainer.addEventListener('mousemove', (e) => updatePlayerPosition(e.clientX, e.clientY));
        gameContainer.addEventListener('touchmove', (e) => {
            e.preventDefault();
            if (e.touches.length > 0) updatePlayerPosition(e.touches[0].clientX, e.touches[0].clientY);
        });
        gameContainer.addEventListener('touchstart', (e) => {
            e.preventDefault();
            if (e.touches.length > 0) updatePlayerPosition(e.touches[0].clientX, e.touches[0].clientY);
        });
        
        function getStarTypes() {
            return baseStarTypes.map(star => ({
                ...star,
                points: Math.floor(star.basePoints * globalLevel * (doublePointsTime > 0 ? 2 : 1))
            }));
        }
        
        function getRandomStarType() {
            const starTypes = getStarTypes();
            const random = Math.random();
            let cumulative = 0;
            for (let type of starTypes) {
                cumulative += type.chance;
                if (random < cumulative) return type;
            }
            return starTypes[0];
        }
        
        function getRandomPowerup() {
            const availablePowerups = powerupTypes.filter(p => globalLevel >= p.minLevel);
            if (availablePowerups.length === 0) return null;
            
            const totalChance = availablePowerups.reduce((sum, p) => sum + p.chance, 0);
            const random = Math.random() * totalChance;
            let cumulative = 0;
            for (let powerup of availablePowerups) {
                cumulative += powerup.chance;
                if (random < cumulative) return powerup;
            }
            return null;
        }
        
        function showFloatingText(x, y, text, className) {
            const element = document.createElement('div');
            element.className = className;
            element.textContent = text;
            element.style.left = x + 'px';
            element.style.top = y + 'px';
            gameContainer.appendChild(element);
            
            setTimeout(() => {
                if (element.parentNode) element.remove();
            }, 1000);
        }
        
        function createFallingObject() {
            if (!gameRunning) return;
            
            const random = Math.random();
            const object = document.createElement('div');
            let objectType = 'star';
            
            const totalThreatChance = bombChance * 1.5;
            const bombChanceActual = bombChance * 0.6;
            const blackholeChance = bombChance * 0.25;
            
            if (random < totalThreatChance) {
                const threatRandom = Math.random();
                
                if (threatRandom < (bombChanceActual / totalThreatChance)) {
                    objectType = 'bomb';
                    object.className = 'bomb falling-object';
                    object.textContent = 'ğŸ’¥';
                } else if (threatRandom < ((bombChanceActual + blackholeChance) / totalThreatChance)) {
                    objectType = 'blackhole';
                    object.className = 'blackhole falling-object';
                    object.textContent = 'ğŸ•³ï¸';
                    object.dataset.pullRadius = '80';
                } else {
                    objectType = 'lightning';
                    object.className = 'lightning falling-object';
                    object.textContent = 'â›ˆï¸';
                    object.dataset.speed = Math.random() > 0.5 ? 'fast' : 'normal';
                }
            } else {
                const powerupMultiplier = Math.min(globalLevel, 3);
                const powerupCheck = Math.random();
                const powerup = getRandomPowerup();
                
                if (powerup && powerupCheck < (0.08 * powerupMultiplier)) {
                    objectType = 'powerup';
                    object.className = 'powerup falling-object';
                    object.textContent = powerup.emoji;
                    object.dataset.powerupType = powerup.type;
                } else {
                    const starType = getRandomStarType();
                    object.className = `star ${starType.class} falling-object`;
                    object.textContent = starType.emoji;
                    object.dataset.points = starType.points;
                    object.dataset.starType = starType.emoji;
                    objectType = 'star';
                }
            }
            
            const containerRect = gameContainer.getBoundingClientRect();
            object.style.left = Math.random() * (containerRect.width - 40) + 'px';
            object.style.top = '-40px';
            
            gameContainer.appendChild(object);
            
            if (magnetTime > 0 && objectType === 'star') {
                object.dataset.magnetic = 'true';
            }
            
            function fall() {
                if (!gameRunning || !object.parentNode) {
                    if (object.parentNode) object.remove();
                    return;
                }
                
                const currentTop = parseInt(object.style.top) || 0;
                let fallSpeed = speedBoostTime > 0 ? starSpeed * 1.5 : starSpeed;
                
                if (freezeTime > 0) fallSpeed *= 0.3;
                if (objectType === 'lightning' && object.dataset.speed === 'fast') fallSpeed *= 1.5;
                
                if (objectType === 'blackhole') {
                    const pullRadius = parseInt(object.dataset.pullRadius) || 80;
                    const blackholeX = parseInt(object.style.left) + 15;
                    const blackholeY = parseInt(object.style.top) + 15;
                    
                    const playerDistance = Math.sqrt(Math.pow(mouseX - blackholeX, 2) + Math.pow(mouseY - blackholeY, 2));
                    if (playerDistance < pullRadius) {
                        const pullStrength = (pullRadius - playerDistance) / pullRadius * 0.8;
                        mouseX += (blackholeX - mouseX) * pullStrength;
                        mouseY += (blackholeY - mouseY) * pullStrength;
                        
                        const containerRect = gameContainer.getBoundingClientRect();
                        mouseX = Math.max(20, Math.min(containerRect.width - 20, mouseX));
                        mouseY = Math.max(20, Math.min(containerRect.height - 20, mouseY));
                        
                        player.style.left = (mouseX - 20) + 'px';
                        player.style.top = (mouseY - 20) + 'px';
                    }
                }
                
                if (object.dataset.magnetic === 'true') {
                    const currentLeft = parseInt(object.style.left) || 0;
                    object.style.left = (currentLeft + ((mouseX - 20) - currentLeft) * 0.03) + 'px';
                }
                
                object.style.top = (currentTop + fallSpeed) + 'px';
                
                const objectRect = object.getBoundingClientRect();
                const playerRect = player.getBoundingClientRect();
                
                if (objectRect.left < playerRect.right &&
                    objectRect.right > playerRect.left &&
                    objectRect.top < playerRect.bottom &&
                    objectRect.bottom > playerRect.top) {
                    handleCollision(object, objectType);
                    return;
                }
                
                const containerRect = gameContainer.getBoundingClientRect();
                if (currentTop > containerRect.height) {
                    if (object.parentNode) object.remove();
                    if (objectType === 'star') resetCombo();
                    return;
                }
                
                requestAnimationFrame(fall);
            }
            
            requestAnimationFrame(fall);
        }
        
        function handleCollision(object, objectType) {
            const rect = object.getBoundingClientRect();
            const gameRect = gameContainer.getBoundingClientRect();
            const x = rect.left - gameRect.left;
            const y = rect.top - gameRect.top;
            
            if (objectType === 'bomb') {
                if (shieldTime > 0) {
                    bombsAvoided++;
                    showFloatingText(x, y, '×—×¡×•×!', 'combo-text');
                } else {
                    lives--;
                    updateLives();
                    showFloatingText(x, y, '×‘×•×!', 'points-text');
                    resetCombo();
                    if (lives <= 0) endStage(false);
                }
            } else if (objectType === 'blackhole') {
                if (shieldTime > 0) {
                    blackholesAvoided++;
                    showFloatingText(x, y, '××’×Ÿ ××—×•×¨!', 'combo-text');
                } else {
                    lives -= 2;
                    updateLives();
                    showFloatingText(x, y, '× ×‘×œ×¢!', 'points-text');
                    resetCombo();
                    speedBoostTime = freezeTime = magnetTime = doublePointsTime = 0;
                    if (lives <= 0) endStage(false);
                }
            } else if (objectType === 'lightning') {
                if (shieldTime > 0) {
                    lightningAvoided++;
                    showFloatingText(x, y, '×”×’× ×”!', 'combo-text');
                } else {
                    speedBoostTime = freezeTime = 0;
                    const containerRect = gameContainer.getBoundingClientRect();
                    mouseX = Math.random() * (containerRect.width - 40) + 20;
                    mouseY = Math.random() * (containerRect.height - 40) + 20;
                    player.style.left = (mouseX - 20) + 'px';
                    player.style.top = (mouseY - 20) + 'px';
                    showFloatingText(x, y, '×–×¢×–×•×¢!', 'points-text');
                    resetCombo();
                }
            } else if (objectType === 'powerup') {
                handlePowerup(object.dataset.powerupType, x, y);
            } else if (objectType === 'star') {
                starsCaught++;
                levelStarsCaught++;
                let points = parseInt(object.dataset.points) * combo;
                
                score += points;
                levelScore += points;
                updateScore();
                updateProgress();
                
                const target = Math.floor(baseStageTargets[currentStage - 1] * globalLevel);
                if (score >= target) {
                    endStage(true);
                    return;
                }
                
                if (lastStarType === object.dataset.starType) {
                    comboCount++;
                    if (comboCount >= 2) {
                        combo = Math.min(combo + 1, 5);
                        maxCombo = Math.max(maxCombo, combo);
                        updateCombo();
                        showFloatingText(x, y, `×§×•××‘×• x${combo}!`, 'combo-text');
                    }
                } else {
                    comboCount = 1;
                    combo = Math.max(combo - 1, 1);
                    updateCombo();
                }
                
                lastStarType = object.dataset.starType;
                showFloatingText(x, y, `+${points}`, 'points-text');
            }
            
            if (object.parentNode) object.remove();
        }
        
        function handlePowerup(type, x, y) {
            switch(type) {
                case 'shield':
                    shieldTime = 600; // 10 seconds
                    player.classList.add('player-shield');
                    showFloatingText(x, y, '××’×Ÿ!', 'combo-text');
                    break;
                case 'life':
                    lives = Math.min(lives + 1, 5);
                    updateLives();
                    showFloatingText(x, y, '×—×™×™×!', 'combo-text');
                    break;
                case 'speed':
                    speedBoostTime = 480; // 8 seconds
                    showFloatingText(x, y, '××”×™×¨×•×ª!', 'combo-text');
                    break;
                case 'freeze':
                    freezeTime = 300; // 5 seconds
                    showFloatingText(x, y, '×”×§×¤××”!', 'combo-text');
                    break;
                case 'magnet':
                    magnetTime = 420; // 7 seconds
                    showFloatingText(x, y, '××’× ×˜!', 'combo-text');
                    break;
                case 'double':
                    doublePointsTime = 420; // 7 seconds
                    showFloatingText(x, y, '× ×§×•×“×•×ª x2!', 'combo-text');
                    break;
            }
        }
        
        function resetCombo() {
            combo = 1;
            comboCount = 0;
            lastStarType = null;
            updateCombo();
        }
        
        function updateScore() {
            document.getElementById('score').textContent = score;
        }
        
        function updateLives() {
            document.getElementById('lives').textContent = Math.max(0, lives);
        }
        
        function updateCombo() {
            document.getElementById('combo').textContent = 'x' + combo;
        }

        function updateProgress() {
            const target = Math.floor(baseStageTargets[currentStage - 1] * globalLevel);
            const progress = Math.min((score / target) * 100, 100);
            document.getElementById('progressFill').style.width = progress + '%';
            document.getElementById('progressText').textContent = `${score} / ${target}`;
        }

        function updatePowerupTimers() {
            if (shieldTime > 0) { shieldTime--; if (shieldTime === 0) player.classList.remove('player-shield'); }
            if (speedBoostTime > 0) speedBoostTime--;
            if (freezeTime > 0) freezeTime--;
            if (magnetTime > 0) magnetTime--;
            if (doublePointsTime > 0) doublePointsTime--;
            updateSpecialStatus();
        }

        function updateSpecialStatus() {
            let specialText = '';
            if (shieldTime > 0) specialText += `ğŸ›¡ï¸(${Math.ceil(shieldTime / 60)}) `;
            if (speedBoostTime > 0) specialText += `âš¡(${Math.ceil(speedBoostTime / 60)}) `;
            if (freezeTime > 0) specialText += `â„ï¸(${Math.ceil(freezeTime / 60)}) `;
            if (magnetTime > 0) specialText += `ğŸ§²(${Math.ceil(magnetTime / 60)}) `;
            if (doublePointsTime > 0) specialText += `ğŸ’(${Math.ceil(doublePointsTime / 60)}) `;
            document.getElementById('special').textContent = specialText.trim() || '××™×Ÿ';
        }

        function updateLegends() {
            document.getElementById('freezeLegend').style.opacity = globalLevel >= 2 ? '1' : '0.5';
            document.getElementById('magnetLegend').style.opacity = globalLevel >= 3 ? '1' : '0.5';
            document.getElementById('doubleLegend').style.opacity = globalLevel >= 4 ? '1' : '0.5';
        }

        function gameLoop() {
            if (Math.random() < spawnRate) {
                createFallingObject();
            }
        }

        function clearObjects() {
            const objects = document.querySelectorAll('.falling-object, .points-text, .combo-text');
            objects.forEach(obj => obj.remove());
        }

        // ×¤×•× ×§×¦×™×•×ª ×œ×©××™×¨×” ×•×˜×¢×™× ×” ×‘×××¦×¢×•×ª Cookies
        function saveGame() {
            const gameState = {
                globalLevel: globalLevel,
                currentStage: currentStage,
                lives: lives
            };
            setCookie('catchTheStarGameState', gameState, 30); // ×©××•×¨ ×œ-30 ×™×•×
        }

        function loadGame() {
            const savedState = getCookie('catchTheStarGameState');
            if (savedState) {
                globalLevel = savedState.globalLevel;
                currentStage = savedState.currentStage;
                lives = savedState.lives;
            }
            // ×¢×“×›×•×Ÿ ×”×××©×§
            document.getElementById('globalLevel').textContent = `×¨××” ×’×œ×•×‘×œ×™×ª: ${globalLevel} (××›×¤×™×œ × ×§×•×“×•×ª: x${globalLevel})`;
            document.getElementById('stageNum').textContent = `${currentStage}/20`;
            document.getElementById('completedStages').textContent = `${currentStage}/20`;
            const levelProgress = Math.min((currentStage / 20) * 100, 100);
            document.getElementById('levelProgressFill').style.width = levelProgress + '%';
            document.getElementById('levelProgressText').textContent = `${currentStage}/20`;

            updateLives();
            updateLegends();
        }

        // ×¤×•× ×§×¦×™×” ×œ×©××™×¨×ª × ×ª×•× ×™× ×‘×¢×•×’×™×”
        function setCookie(name, value, days) {
            const d = new Date();
            d.setTime(d.getTime() + (days * 24 * 60 * 60 * 1000));
            let expires = "expires=" + d.toUTCString();
            document.cookie = name + "=" + encodeURIComponent(JSON.stringify(value)) + ";" + expires + ";path=/";
        }

        // ×¤×•× ×§×¦×™×” ×œ×§×¨×™××ª × ×ª×•× ×™× ××¢×•×’×™×”
        function getCookie(name) {
            let cookieName = name + "=";
            let decodedCookie = decodeURIComponent(document.cookie);
            let ca = decodedCookie.split(';');
            for (let i = 0; i < ca.length; i++) {
                let c = ca[i];
                while (c.charAt(0) == ' ') {
                    c = c.substring(1);
                }
                if (c.indexOf(cookieName) == 0) {
                    try {
                        return JSON.parse(c.substring(cookieName.length, c.length));
                    } catch (e) {
                        console.error("Failed to parse cookie data", e);
                        return null;
                    }
                }
            }
            return null;
        }

        function startStage(stage) {
            document.getElementById('modal').style.display = 'none';

            currentStage = stage;
            score = 0;
            combo = 1;
            maxCombo = 1;
            comboCount = 0;
            shieldTime = speedBoostTime = freezeTime = magnetTime = doublePointsTime = 0;
            starsCaught = bombsAvoided = blackholesAvoided = lightningAvoided = 0;
            stageStartTime = Date.now();
            
            // Adjust difficulty
            starSpeed = 2 + (currentStage * 0.1) + (globalLevel * 0.2);
            spawnRate = 0.025 + (currentStage * 0.001) + (globalLevel * 0.002);
            bombChance = 0.1 + (currentStage * 0.005) + (globalLevel * 0.01);

            document.getElementById('gameOver').style.display = 'none';
            document.getElementById('stageComplete').style.display = 'none';
            document.getElementById('levelComplete').style.display = 'none';
            
            const target = Math.floor(baseStageTargets[currentStage - 1] * globalLevel);
            document.getElementById('stageTitle').textContent = `×©×œ×‘ ${currentStage}: ${stageNames[currentStage - 1]}`;
            document.getElementById('stageGoal').textContent = `×™×¢×“: ${target} × ×§×•×“×•×ª`;
            document.getElementById('stageNum').textContent = `${currentStage}/20`;
            
            updateScore();
            updateLives();
            updateCombo();
            updateProgress();
            updateSpecialStatus();
            clearObjects();

            gameRunning = true;
            gameInterval = setInterval(gameLoop, 16); // ~60fps
            timerInterval = setInterval(updatePowerupTimers, 1000 / 60);
        }

        function endStage(success) {
            gameRunning = false;
            clearInterval(gameInterval);
            clearInterval(timerInterval);
            clearObjects();

            if (success) {
                const stageTime = ((Date.now() - stageStartTime) / 1000).toFixed(1);

                document.getElementById('completedStage').textContent = currentStage;
                document.getElementById('completedStageName').textContent = stageNames[currentStage - 1];
                document.getElementById('stageScore').textContent = score;
                document.getElementById('stageTime').textContent = stageTime;
                document.getElementById('stageMaxCombo').textContent = 'x' + maxCombo;
                document.getElementById('starsCaught').textContent = starsCaught;
                document.getElementById('bombsAvoided').textContent = bombsAvoided;
                document.getElementById('blackholesAvoided').textContent = blackholesAvoided;
                document.getElementById('lightningAvoided').textContent = lightningAvoided;

                document.getElementById('levelScore').textContent = levelScore;
                document.getElementById('completedStages').textContent = `${currentStage}/20`;
                
                const levelProgress = Math.min((currentStage / 20) * 100, 100);
                document.getElementById('levelProgressFill').style.width = levelProgress + '%';
                document.getElementById('levelProgressText').textContent = `${currentStage}/20`;

                if (currentStage >= 20) {
                    document.getElementById('nextStageText').textContent = '×¡×™×™× ×¨××”!';
                } else {
                    document.getElementById('nextStageText').textContent = '×©×œ×‘ ×”×‘× â†’';
                }

                document.getElementById('stageComplete').style.display = 'block';
                saveGame();
            } else {
                const target = Math.floor(baseStageTargets[currentStage - 1] * globalLevel);
                document.getElementById('failScore').textContent = score;
                document.getElementById('failTarget').textContent = target;
                document.getElementById('gameOver').style.display = 'block';
                saveGame();
            }
        }

        function checkLevelUp() {
            if (currentStage >= 20) {
                document.getElementById('stageComplete').style.display = 'none';
                
                document.getElementById('completedLevel').textContent = globalLevel;
                document.getElementById('newLevel').textContent = globalLevel + 1;
                document.getElementById('newMultiplier').textContent = globalLevel + 1;
                
                globalLevel++;
                levelScore = 0;
                levelStarsCaught = 0;
                
                document.getElementById('globalLevel').textContent = `×¨××” ×’×œ×•×‘×œ×™×ª: ${globalLevel} (××›×¤×™×œ × ×§×•×“×•×ª: x${globalLevel})`;
                updateLegends();
                saveGame();

                document.getElementById('levelComplete').style.display = 'block';
            } else {
                nextStage();
            }
        }
        
        function nextStage() {
            if (currentStage >= 20) {
                checkLevelUp();
            } else {
                currentStage++;
                startStage(currentStage);
            }
        }

        function retryStage() {
            lives = Math.max(lives, 1); // Get at least one life to retry
            updateLives();
            startStage(currentStage);
        }

        function restartGame() {
            globalLevel = 1;
            currentStage = 1;
            lives = 3;
            levelScore = 0;
            document.getElementById('globalLevel').textContent = `×¨××” ×’×œ×•×‘×œ×™×ª: ${globalLevel} (××›×¤×™×œ × ×§×•×“×•×ª: x${globalLevel})`;
            updateLegends();
            saveGame();
            startStage(1);
        }

        function nextLevel() {
            currentStage = 1;
            startStage(1);
        }
        
        // Initial game start
        loadGame();
    </script>
</body>
</html>
